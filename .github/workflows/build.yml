name: Build Local Hub v2 Installer

on:
  push:
    branches:
      - master

jobs:

  prepare-build-source:
    if: "contains(github.event.head_commit.message, 'build')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v4

      # Create build_src folder
      - name: Prepare build_src folder
        run: |
          rm -rf build_src
          mkdir build_src

      # Copy required files â€” Python, templates, static, extras
      - name: Copy Source Files
        run: |
          cp -r core build_src/
          cp -r assets build_src/
          cp main.py build_src/
          cp config.py build_src/
          cp icon.ico build_src/
          cp README.txt build_src/
          cp .env.template build_src/
          cp ngrok.exe build_src/

      # Optional: Obfuscate Python
      - name: Obfuscate Python Core
        run: |
          pip install pyarmor
          
          mkdir build_src
          robocopy . build_src /E /XF *.pyc __pycache__

          rem Obfuscate core package
          pyarmor gen -O build_src/core_obf core

          rem Replace original core folder with obfuscated version
          rmdir /S /Q build_src/core
          ren build_src/core_obf core

          rem Obfuscate config.py
          pyarmor gen -O build_src config.py
        shell: cmd


      # Optional: Obfuscate JS and HTML
      - name: Obfuscate JS & HTML
        run: |
          npm install -g javascript-obfuscator html-minifier cssnano
          find build_src/assets/static -name "*.js" -exec javascript-obfuscator {} --output {} \;
          find build_src/assets/templates -name "*.html" -exec html-minifier --collapse-whitespace --remove-comments --minify-css true --minify-js true -o {} {} \;

      # Commit build_src branch
      - name: Push to build_src branch
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B build_src
          git add build_src
          git commit -m "Auto build source"
          git push -f origin build_src

  build-windows-installer:
    needs: prepare-build-source
    runs-on: windows-latest
    steps:

      - name: Checkout build_src branch
        uses: actions/checkout@v4
        with:
          ref: build_src

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build EXE with PyInstaller
        run: |
          python -m PyInstaller ^
            main.py ^
            --name "LocalHubV2" ^
            --onedir ^
            --noconfirm ^
            --noconsole ^
            --clean ^
            --icon "icon.ico" ^
            --add-data "assets;assets" ^
            --add-data "config.py;." ^
            --collect-all core ^
            --collect-all flet ^
            --collect-all flask ^
            --collect-all watchdog ^
            --collect-all werkzeug ^
            --collect-all jinja2 ^
            --collect-all markupsafe ^
            --collect-all itsdangerous ^
            --collect-all pyperclip ^
            --collect-all PIL ^
            --exclude-module eventlet ^
            --exclude-module gevent ^
            --exclude-module gevent-websocket ^
            --exclude-module flask_socketio ^
            --exclude-module socketio ^
            --exclude-module engineio
        shell: cmd


      # Copy extra files to the final build folder
      - name: Copy bundle extras
        run: |
          copy ngrok.exe dist\LocalHub_v2\
          copy README.txt dist\LocalHub_v2\
          copy .env.template dist\LocalHub_v2\.env
          copy icon.ico dist\LocalHub_v2\
          

      - name: Build Installer with Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: setup.iss

      # Tag version
      - name: Version Tag
        id: version
        shell: pwsh
        run: |
          echo "version_tag=v2.0.${{ github.run_number }}" >> $env:GITHUB_OUTPUT

      - name: Release Installer
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: "Local Hub v2 - Release ${{ steps.version.outputs.version_tag }}"
          files: Output/LocalHub_Setup.exe
