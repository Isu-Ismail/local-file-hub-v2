name: Build Local Hub v2 Installer

on:
  push:
    branches:
      - master
  
jobs:
  build-windows-release:
    if: "contains(github.event.head_commit.message, 'build')"
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      # --- FIX 1: Download Ngrok (Because it is likely missing in the repo) ---
      - name: Download Ngrok
        run: |
          curl -L -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
          tar -xf ngrok.zip
          del ngrok.zip
        shell: cmd

      # --- FIX 2: Run Batch with 'python' check ---
      - name: Build executable (Core)
        run: |
          :: Run the batch file to build dist/LocalHub_v2.exe
          .\BUILD_EXE.bat
        shell: cmd

      # --- Debug Step: Check if dist exists ---
      - name: Check Build Output
        run: |
          if exist dist\LocalHub_v2.exe ( echo Build Successful ) else ( echo Build Failed & dir & exit 1 )
        shell: cmd

      # --- FIX 3: Removed '#' comments to prevent syntax error ---
      - name: Create installer with NSIS
        run: |
          .\.tools\NSIS\makensis.exe setup.nsi
        shell: cmd

      - name: Set up version tag
        id: version
        run: |
          $version = "v2.0.${{ github.run_number }}"
          echo "version_tag=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: "Local Hub v2 - Release ${{ steps.version.outputs.version_tag }}"
          draft: false
          prerelease: false
          files: |
            LocalHub_Setup.exe